<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>AI Interview Guide</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet"/>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0a0a0f; --bg2: #0f0f1a; --card: #111120;
    --border: #1e1e2e; --text: #e8e4dc; --muted: #555;
    --green: #00e5a0; --yellow: #f5c542; --red: #ff5e5e; --blue: #4f9eff;
  }
  body { background: var(--bg); color: var(--text); font-family: 'Syne', sans-serif; min-height: 100vh; padding: 2rem; }
  h1 { font-size: 1.8rem; font-weight: 800; margin-bottom: 0.25rem; }
  h2 { font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem; }
  h3 { font-size: 1rem; font-weight: 700; margin-bottom: 0.5rem; }
  .subtitle { color: var(--muted); font-size: 0.88rem; margin-bottom: 2rem; }
  hr { border: none; border-top: 1px solid var(--border); margin: 1.5rem 0; }

  /* Step bar */
  .step-bar { display: flex; margin-bottom: 2rem; }
  .step { flex: 1; padding: 0.65rem 0.5rem; text-align: center; font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase; font-weight: 600; border-bottom: 3px solid var(--border); color: #444; }
  .step.active { color: var(--green); border-bottom-color: var(--green); }
  .step.done   { color: #555; border-bottom-color: #00e5a060; }

  /* Pages */
  .page { display: none; }
  .page.active { display: block; }

  /* Cards */
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem 1.5rem; margin-bottom: 1rem; }
  .card-accent { border-left: 3px solid var(--green); }

  /* Form */
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem; }
  .form-group { margin-bottom: 1rem; }
  label { font-size: 0.8rem; font-weight: 600; color: #aaa; display: block; margin-bottom: 0.4rem; }
  input, select, textarea {
    width: 100%; background: var(--card); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-family: 'IBM Plex Mono', monospace;
    font-size: 0.85rem; padding: 0.65rem 0.85rem; outline: none;
  }
  input:focus, select:focus, textarea:focus { border-color: var(--green); }
  select option { background: var(--card); }
  textarea { resize: vertical; }

  /* Focus area tags */
  .tags { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-top: 0.4rem; }
  .tag { font-family: 'IBM Plex Mono', monospace; font-size: 0.72rem; padding: 0.25rem 0.65rem; border-radius: 999px; border: 1px solid var(--border); color: #555; cursor: pointer; background: transparent; transition: all 0.2s; }
  .tag.on { background: #00e5a015; border-color: #00e5a040; color: var(--green); }

  /* Buttons */
  .btn { background: var(--green); color: var(--bg); border: none; border-radius: 8px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.95rem; padding: 0.7rem 1.5rem; cursor: pointer; transition: opacity 0.2s; display: inline-flex; align-items: center; gap: 0.5rem; }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.45; cursor: not-allowed; }
  .btn-full { width: 100%; justify-content: center; }
  .btn-ghost { background: var(--border); color: var(--text); }
  .btn-row { display: flex; gap: 0.75rem; margin-top: 1rem; }

  /* Spinner */
  .spin { display: inline-block; width: 15px; height: 15px; border: 2px solid var(--bg); border-top-color: transparent; border-radius: 50%; animation: spin 0.7s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Question card */
  .q-card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 0.75rem; }
  .q-meta { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center; }
  .q-num { font-family: 'IBM Plex Mono', monospace; font-size: 0.65rem; color: var(--green); letter-spacing: 0.2em; }
  .badge { font-size: 0.62rem; padding: 0.1rem 0.5rem; border-radius: 999px; font-family: 'IBM Plex Mono', monospace; border: 1px solid; }
  .q-text { font-size: 0.92rem; line-height: 1.6; font-weight: 600; margin-bottom: 0.35rem; }
  .q-hint { font-size: 0.75rem; color: #555; font-family: 'IBM Plex Mono', monospace; }

  /* Progress */
  .prog-label { display: flex; justify-content: space-between; font-size: 0.72rem; color: #555; font-family: 'IBM Plex Mono', monospace; margin-bottom: 0.4rem; }
  .prog-track { background: #1e1e2e; border-radius: 999px; height: 5px; margin-bottom: 1.5rem; overflow: hidden; }
  .prog-fill  { height: 100%; background: var(--green); border-radius: 999px; transition: width 0.4s; }

  /* Chat */
  .chat-log { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.25rem; max-height: 360px; overflow-y: auto; }
  .bubble-ai   { background: var(--card); border: 1px solid var(--border); border-radius: 12px 12px 12px 4px; padding: 0.85rem 1.1rem; max-width: 90%; }
  .bubble-user { background: #001a12; border: 1px solid #00e5a020; border-radius: 12px 12px 4px 12px; padding: 0.85rem 1.1rem; max-width: 85%; align-self: flex-end; }
  .blabel { font-size: 0.62rem; letter-spacing: 0.15em; text-transform: uppercase; color: #555; margin-bottom: 0.3rem; font-family: 'IBM Plex Mono', monospace; }
  .btext  { font-size: 0.88rem; line-height: 1.7; }

  /* Scores */
  .scores-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.75rem; margin-bottom: 1.25rem; }
  .metric { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; text-align: center; }
  .metric-val { font-size: 2.4rem; font-weight: 800; font-family: 'IBM Plex Mono', monospace; }
  .metric-lbl { font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: #555; margin-top: 0.3rem; }
  .score-high { color: var(--green); } .score-mid { color: var(--yellow); } .score-low { color: var(--red); }

  /* Feedback cols */
  .fb-cols { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1.25rem; }
  .fb-box { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
  .fb-title { font-size: 0.68rem; letter-spacing: 0.18em; text-transform: uppercase; color: #555; margin-bottom: 0.75rem; }
  .fb-item { padding-left: 0.75rem; margin-bottom: 0.5rem; font-size: 0.85rem; line-height: 1.5; }
  .fb-s { border-left: 3px solid var(--green); }
  .fb-w { border-left: 3px solid var(--red); }
  .fb-sg { border-left: 3px solid var(--yellow); }

  /* Verdict */
  .verdict { border-radius: 12px; padding: 1.5rem; text-align: center; margin-bottom: 1.5rem; }
  .verdict-lbl  { font-size: 0.68rem; letter-spacing: 0.2em; text-transform: uppercase; font-family: 'IBM Plex Mono', monospace; margin-bottom: 0.4rem; }
  .verdict-text { font-size: 1.4rem; font-weight: 800; }
  .verdict-sum  { font-size: 0.88rem; color: #888; margin-top: 0.5rem; }

  /* Expander */
  details { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 1rem 1.25rem; margin-bottom: 0.6rem; }
  summary { font-size: 0.88rem; font-weight: 600; cursor: pointer; }
  .detail-inner { margin-top: 0.85rem; font-size: 0.85rem; }
  .ans-box { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem; color: #aaa; font-size: 0.85rem; margin-bottom: 0.75rem; }
  .ideal { border-left: 3px solid var(--yellow); padding-left: 0.75rem; font-size: 0.82rem; color: var(--yellow); }

  /* Next steps */
  .next-item { background: var(--card); border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 0.5rem; display: flex; gap: 1rem; align-items: center; }
  .next-num  { font-family: 'IBM Plex Mono', monospace; color: var(--green); font-size: 0.85rem; min-width: 28px; }

  /* Alert */
  .alert { border-radius: 8px; padding: 0.65rem 1rem; font-size: 0.82rem; margin-bottom: 1rem; display: none; }
  .alert.show { display: block; }
  .alert-err { background: #ff5e5e15; border: 1px solid #ff5e5e40; color: var(--red); }
  .alert-ok  { background: #00e5a015; border: 1px solid #00e5a040; color: var(--green); }

  /* Complete banner */
  .complete-banner { background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 2rem; text-align: center; margin-bottom: 1rem; }

  @media (max-width: 700px) {
    .form-row, .scores-grid, .fb-cols { grid-template-columns: 1fr; }
    .scores-grid { grid-template-columns: 1fr 1fr; }
  }
</style>
</head>
<body>

<h1>üéØ AI Interview Guide</h1>
<p class="subtitle">Mock interview simulation powered by Gemini ‚Äî Backend: http://localhost:8000</p>

<!-- Step Bar -->
<div class="step-bar">
  <div class="step active" id="s1">1 ¬∑ Setup</div>
  <div class="step" id="s2">2 ¬∑ Questions</div>
  <div class="step" id="s3">3 ¬∑ Simulation</div>
  <div class="step" id="s4">4 ¬∑ Feedback</div>
</div>

<div class="alert alert-err" id="globalErr"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE 1 ‚Äî SETUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page active" id="page1">
  <h2>üöÄ Setup Interview</h2>
  <div class="form-row">
    <div class="form-group">
      <label>Job Role / Position</label>
      <input type="text" id="role" placeholder="e.g. Senior Data Scientist, Frontend Engineer..."/>
    </div>
    <div class="form-group">
      <label>Experience Level</label>
      <select id="experience">
        <option>Entry Level (0-2 yrs)</option>
        <option>Mid Level (2-5 yrs)</option>
        <option selected>Senior Level (5-8 yrs)</option>
        <option>Lead / Principal (8+ yrs)</option>
      </select>
    </div>
  </div>
  <div class="form-group">
    <label>Focus Areas (optional ‚Äî click to select)</label>
    <div class="tags" id="focusTags">
      <span class="tag" onclick="toggleTag(this)">Machine Learning</span>
      <span class="tag" onclick="toggleTag(this)">System Design</span>
      <span class="tag" onclick="toggleTag(this)">Data Structures</span>
      <span class="tag" onclick="toggleTag(this)">Behavioral</span>
      <span class="tag" onclick="toggleTag(this)">Leadership</span>
      <span class="tag" onclick="toggleTag(this)">Frontend</span>
      <span class="tag" onclick="toggleTag(this)">Backend</span>
      <span class="tag" onclick="toggleTag(this)">DevOps</span>
      <span class="tag" onclick="toggleTag(this)">Cloud</span>
      <span class="tag" onclick="toggleTag(this)">SQL</span>
      <span class="tag" onclick="toggleTag(this)">Python</span>
    </div>
  </div>
  <button class="btn btn-full" id="startBtn" onclick="startInterview()">üéØ &nbsp;Start Interview Prep</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE 2 ‚Äî QUESTIONS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page2">
  <h2 id="qPageTitle">üìã Interview Questions</h2>
  <p style="color:var(--muted);font-size:0.85rem;margin-bottom:1.25rem">Review your AI-generated questions before the simulation begins</p>
  <div id="questionsList"></div>
  <div class="btn-row">
    <button class="btn btn-ghost" onclick="regenQuestions()">üîÑ Regenerate</button>
    <button class="btn" onclick="startSimulation()">‚ñ∂Ô∏è &nbsp;Start Mock Interview</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE 3 ‚Äî SIMULATION
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page3">
  <h2 id="simTitle">üí¨ Mock Interview</h2>

  <div class="prog-label">
    <span id="progText">Question 1 of 7</span>
    <span id="progPct">0% complete</span>
  </div>
  <div class="prog-track"><div class="prog-fill" id="progFill" style="width:0%"></div></div>

  <!-- Chat history -->
  <div class="chat-log" id="chatLog"></div>

  <!-- Current question card -->
  <div id="currentQCard" class="card card-accent" style="display:none">
    <div id="currentQMeta" style="font-size:0.65rem;letter-spacing:0.2em;color:var(--green);font-family:'IBM Plex Mono',monospace;margin-bottom:0.5rem"></div>
    <div id="currentQText" style="font-size:1rem;font-weight:600;line-height:1.7;margin-bottom:1rem"></div>
    <textarea id="answerInput" rows="5" placeholder="Type your answer here... Take your time, think it through."></textarea>
    <div class="btn-row">
      <button class="btn" style="flex:3" id="submitBtn" onclick="submitAnswer()">üì® &nbsp;Submit Answer</button>
      <button class="btn btn-ghost" style="flex:1" onclick="skipQuestion()">‚è≠ Skip</button>
    </div>
  </div>

  <!-- Complete state -->
  <div id="completeCard" style="display:none">
    <div class="complete-banner">
      <div style="font-size:2.5rem;margin-bottom:0.5rem">üéâ</div>
      <div style="font-size:1.1rem;font-weight:700;margin-bottom:0.5rem">Interview Simulation Complete!</div>
      <div id="completeSub" style="color:var(--muted);font-size:0.88rem"></div>
    </div>
    <button class="btn btn-full" onclick="getFeedback()">üìä &nbsp;Get Performance Feedback</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     PAGE 4 ‚Äî FEEDBACK
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="page" id="page4">
  <h2 id="fbTitle">üìä Performance Feedback</h2>
  <p style="color:var(--muted);font-size:0.85rem;margin-bottom:1.25rem">Detailed AI-powered analysis of your interview performance</p>

  <div id="verdictBanner"></div>
  <div class="scores-grid" id="scoresGrid"></div>

  <div class="fb-cols" id="fbCols"></div>

  <h3>üìù Question-by-Question Breakdown</h3>
  <div id="perQSection" style="margin-bottom:1.5rem"></div>

  <h3>üéØ Next Steps</h3>
  <div id="nextSteps" style="margin-bottom:1.5rem"></div>

  <details style="margin-top:1rem">
    <summary>üî© Raw JSON</summary>
    <pre id="rawJson" style="margin-top:0.75rem;font-size:0.72rem;color:#888;overflow:auto;max-height:300px"></pre>
  </details>

  <button class="btn btn-full btn-ghost" style="margin-top:1.5rem" onclick="resetAll()">üîÑ Start New Interview</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     JAVASCRIPT
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
const API = 'http://localhost:8000';

// ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let state = {
  role: '',
  experience: '',
  focus: [],
  questions: [],
  answers: [],
  chatHistory: [],    // [{question, answer}] for /chat history param
  chatLog: [],        // [{role:'ai'|'user', text}] for display
  currentIdx: 0,
};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showErr(msg) {
  const el = document.getElementById('globalErr');
  el.textContent = '‚ùå ' + msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 6000);
}

function setLoading(btnId, loading, label) {
  const btn = document.getElementById(btnId);
  btn.disabled = loading;
  btn.innerHTML = loading ? `<span class="spin"></span> &nbsp;${label}` : label;
}

function goToPage(n) {
  document.querySelectorAll('.page').forEach((p, i) => p.classList.toggle('active', i + 1 === n));
  ['s1','s2','s3','s4'].forEach((id, i) => {
    const el = document.getElementById(id);
    el.className = 'step' + (i + 1 === n ? ' active' : i + 1 < n ? ' done' : '');
  });
}

function toggleTag(el) { el.classList.toggle('on'); }

function scoreClass(v) { return v >= 75 ? 'score-high' : v >= 50 ? 'score-mid' : 'score-low'; }
function scoreColor(v) { return v >= 75 ? '#00e5a0' : v >= 50 ? '#f5c542' : '#ff5e5e'; }

const TYPE_COLORS = { technical:'#4f9eff', behavioral:'#00e5a0', 'system design':'#f5c542', situational:'#ff9f5e' };
const DIFF_COLORS = { easy:'#00e5a0', medium:'#f5c542', hard:'#ff5e5e' };

// ‚îÄ‚îÄ PAGE 1 ‚Äî SETUP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startInterview() {
  const role = document.getElementById('role').value.trim();
  if (!role) { showErr('Please enter a job role.'); return; }

  state.role       = role;
  state.experience = document.getElementById('experience').value;
  state.focus      = [...document.querySelectorAll('#focusTags .tag.on')].map(t => t.textContent);

  setLoading('startBtn', true, '‚è≥ Generating Questions...');

  try {
    const res = await fetch(`${API}/generate-questions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role: state.role, experience: state.experience, focus: state.focus })
    });
    if (!res.ok) throw new Error((await res.json()).detail);
    const data = await res.json();
    state.questions = data.questions;
    renderQuestions();
    goToPage(2);
  } catch (e) {
    showErr(e.message || 'Failed to generate questions.');
  } finally {
    setLoading('startBtn', false, 'üéØ &nbsp;Start Interview Prep');
  }
}

// ‚îÄ‚îÄ PAGE 2 ‚Äî QUESTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderQuestions() {
  document.getElementById('qPageTitle').textContent = `üìã Interview Questions ‚Äî ${state.role}`;
  const container = document.getElementById('questionsList');
  container.innerHTML = state.questions.map(q => {
    const tc = TYPE_COLORS[q.type?.toLowerCase()] || '#888';
    const dc = DIFF_COLORS[q.difficulty?.toLowerCase()] || '#888';
    return `
    <div class="q-card">
      <div class="q-meta">
        <span class="q-num">Q${q.id}</span>
        <span class="badge" style="color:${tc};border-color:${tc}40;background:${tc}15">${(q.type||'').toUpperCase()}</span>
        <span class="badge" style="color:${dc};border-color:${dc}40;background:${dc}15">${(q.difficulty||'').toUpperCase()}</span>
      </div>
      <div class="q-text">${q.question}</div>
      <div class="q-hint">üí° ${q.hint || ''}</div>
    </div>`;
  }).join('');
}

async function regenQuestions() {
  try {
    const res = await fetch(`${API}/generate-questions`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ role: state.role, experience: state.experience, focus: state.focus })
    });
    if (!res.ok) throw new Error((await res.json()).detail);
    state.questions = (await res.json()).questions;
    renderQuestions();
  } catch (e) { showErr(e.message); }
}

// ‚îÄ‚îÄ PAGE 3 ‚Äî SIMULATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startSimulation() {
  state.answers    = [];
  state.chatHistory = [];
  state.chatLog    = [];
  state.currentIdx = 0;
  document.getElementById('simTitle').textContent = `üí¨ Mock Interview ‚Äî ${state.role}`;
  document.getElementById('chatLog').innerHTML = '';
  goToPage(3);
  renderCurrentQuestion();
}

function updateProgress() {
  const idx   = state.currentIdx;
  const total = state.questions.length;
  const pct   = Math.round((idx / total) * 100);
  document.getElementById('progText').textContent  = `Question ${Math.min(idx + 1, total)} of ${total}`;
  document.getElementById('progPct').textContent   = `${pct}% complete`;
  document.getElementById('progFill').style.width  = pct + '%';
}

function renderCurrentQuestion() {
  const idx   = state.currentIdx;
  const total = state.questions.length;
  updateProgress();

  if (idx >= total) {
    // All done
    document.getElementById('currentQCard').style.display  = 'none';
    document.getElementById('completeCard').style.display  = 'block';
    const answered = state.answers.filter(a => a !== '[Skipped]').length;
    document.getElementById('completeSub').textContent =
      `You answered ${answered} out of ${total} questions`;
    return;
  }

  document.getElementById('completeCard').style.display  = 'none';
  document.getElementById('currentQCard').style.display  = 'block';

  const q  = state.questions[idx];
  const tc = TYPE_COLORS[q.type?.toLowerCase()] || '#888';
  const dc = DIFF_COLORS[q.difficulty?.toLowerCase()] || '#888';

  document.getElementById('currentQMeta').textContent =
    `QUESTION ${idx + 1} ¬∑ ${(q.type||'').toUpperCase()} ¬∑ ${(q.difficulty||'').toUpperCase()}`;
  document.getElementById('currentQText').textContent = q.question;
  document.getElementById('answerInput').value = '';
}

function addBubble(role, text) {
  state.chatLog.push({ role, text });
  const log = document.getElementById('chatLog');
  const div = document.createElement('div');
  div.className = role === 'ai' ? 'bubble-ai' : 'bubble-user';
  div.innerHTML = `
    <div class="blabel">${role === 'ai' ? 'ü§ñ Interviewer' : 'üë§ You'}</div>
    <div class="btext">${text}</div>`;
  log.appendChild(div);
  log.scrollTop = log.scrollHeight;
}

async function submitAnswer() {
  const answer = document.getElementById('answerInput').value.trim();
  if (!answer) { showErr('Please type an answer before submitting.'); return; }

  const idx = state.currentIdx;
  const q   = state.questions[idx];

  // Show in chat
  addBubble('ai',   q.question);
  addBubble('user', answer);

  state.answers.push(answer);

  setLoading('submitBtn', true, 'Interviewer is responding...');

  // Get follow-up (not for last question)
  if (idx < state.questions.length - 1) {
    try {
      const res = await fetch(`${API}/chat`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          role:    state.role,
          question: q.question,
          answer:  answer,
          history: state.chatHistory
        })
      });
      if (!res.ok) throw new Error((await res.json()).detail);
      const { followup } = await res.json();
      addBubble('ai', followup);
    } catch (e) {
      showErr('Could not get interviewer response: ' + e.message);
    }
  }

  // Save to history for context
  state.chatHistory.push({ question: q.question, answer });

  setLoading('submitBtn', false, 'üì® &nbsp;Submit Answer');
  state.currentIdx++;
  renderCurrentQuestion();
}

function skipQuestion() {
  const q = state.questions[state.currentIdx];
  addBubble('ai',   q.question);
  addBubble('user', '[Skipped]');
  state.answers.push('[Skipped]');
  state.chatHistory.push({ question: q.question, answer: '[Skipped]' });
  state.currentIdx++;
  renderCurrentQuestion();
}

// ‚îÄ‚îÄ PAGE 4 ‚Äî FEEDBACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function getFeedback() {
  goToPage(4);
  document.getElementById('fbTitle').textContent = `üìä Performance Feedback ‚Äî ${state.role}`;
  document.getElementById('verdictBanner').innerHTML   = '<div style="color:var(--muted);padding:1rem">‚è≥ Analyzing your performance...</div>';
  document.getElementById('scoresGrid').innerHTML  = '';
  document.getElementById('fbCols').innerHTML      = '';
  document.getElementById('perQSection').innerHTML = '';
  document.getElementById('nextSteps').innerHTML   = '';

  try {
    const res = await fetch(`${API}/feedback`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        role:      state.role,
        questions: state.questions,
        answers:   state.answers
      })
    });
    if (!res.ok) throw new Error((await res.json()).detail);
    const fb = await res.json();
    renderFeedback(fb);
  } catch (e) {
    document.getElementById('verdictBanner').innerHTML =
      `<div class="alert alert-err show">‚ùå ${e.message}</div>`;
  }
}

function renderFeedback(fb) {
  // Verdict
  const verdict = fb.verdict || '';
  const vc = verdict.includes('Strong') ? '#00e5a0' : verdict.includes('Good') ? '#f5c542' : '#ff5e5e';
  document.getElementById('verdictBanner').innerHTML = `
    <div class="verdict" style="background:${vc}10;border:1px solid ${vc}30">
      <div class="verdict-lbl" style="color:${vc}">VERDICT</div>
      <div class="verdict-text" style="color:${vc}">${verdict}</div>
      <div class="verdict-sum">${fb.summary || ''}</div>
    </div>`;

  // Score cards
  const scores = [
    ['Overall Score',        fb.overall_score],
    ['Communication',        fb.communication_score],
    ['Technical Knowledge',  fb.technical_score],
    ['Confidence',           fb.confidence_score],
  ];
  document.getElementById('scoresGrid').innerHTML = scores.map(([lbl, val]) => `
    <div class="metric">
      <div class="metric-val ${scoreClass(val)}">${val}</div>
      <div style="font-size:0.5rem;color:#555;font-family:'IBM Plex Mono',monospace">/100</div>
      <div class="metric-lbl">${lbl}</div>
    </div>`).join('');

  // Strengths / Weaknesses / Suggestions
  document.getElementById('fbCols').innerHTML = `
    <div class="fb-box">
      <div class="fb-title">‚úÖ Strengths</div>
      ${(fb.strengths||[]).map(s=>`<div class="fb-item fb-s">${s}</div>`).join('')}
    </div>
    <div class="fb-box">
      <div class="fb-title">‚ùå Areas to Improve</div>
      ${(fb.weaknesses||[]).map(w=>`<div class="fb-item fb-w">${w}</div>`).join('')}
    </div>
    <div class="fb-box">
      <div class="fb-title">üí° Suggestions</div>
      ${(fb.suggestions||[]).map(s=>`<div class="fb-item fb-sg">${s}</div>`).join('')}
    </div>`;

  // Per question
  document.getElementById('perQSection').innerHTML = (fb.per_question||[]).map(item => {
    const qid  = item.question_id - 1;
    const qObj = state.questions[qid] || {};
    const ans  = state.answers[qid]   || '';
    const sc   = item.score || 0;
    const sc2  = scoreColor(sc);
    return `
    <details>
      <summary>Q${item.question_id} ‚Äî ${(qObj.question||'').slice(0,65)}...&nbsp;&nbsp;<span style="color:${sc2};font-family:'IBM Plex Mono',monospace">[${sc}/100]</span></summary>
      <div class="detail-inner">
        <div style="font-size:0.68rem;color:#555;font-family:'IBM Plex Mono',monospace;margin-bottom:0.3rem">THE QUESTION</div>
        <div style="font-size:0.88rem;font-weight:600;margin-bottom:0.75rem">${qObj.question||''}</div>
        <div style="font-size:0.68rem;color:#555;font-family:'IBM Plex Mono',monospace;margin-bottom:0.3rem">YOUR ANSWER</div>
        <div class="ans-box">${ans}</div>
        <div style="font-size:0.68rem;color:#555;font-family:'IBM Plex Mono',monospace;margin-bottom:0.3rem">FEEDBACK</div>
        <div style="font-size:0.88rem;margin-bottom:0.75rem">${item.comment||''}</div>
        <div class="ideal">üí° Ideal answer would include: ${item.ideal_answer_hint||''}</div>
      </div>
    </details>`;
  }).join('');

  // Next steps
  document.getElementById('nextSteps').innerHTML = (fb.next_steps||[]).map((s,i) => `
    <div class="next-item">
      <span class="next-num">${String(i+1).padStart(2,'0')}</span>
      <span style="font-size:0.88rem">${s}</span>
    </div>`).join('');

  // Raw JSON
  document.getElementById('rawJson').textContent = JSON.stringify(fb, null, 2);
}

// ‚îÄ‚îÄ RESET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function resetAll() {
  state = { role:'', experience:'', focus:[], questions:[], answers:[], chatHistory:[], chatLog:[], currentIdx:0 };
  document.getElementById('role').value = '';
  document.querySelectorAll('#focusTags .tag').forEach(t => t.classList.remove('on'));
  document.getElementById('chatLog').innerHTML = '';
  goToPage(1);
}
</script>
</body>
</html>